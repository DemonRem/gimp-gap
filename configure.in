dnl Process this file with autoconf to produce a configure script.

AC_PREREQ(2.52)
AC_INIT(configure.in)
AM_CONFIG_HEADER(config.h)

GAP_MAJOR_VERSION=2
GAP_MINOR_VERSION=2
GAP_MICRO_VERSION=0
GAP_VERSION=$GAP_MAJOR_VERSION.$GAP_MINOR_VERSION.$GAP_MICRO_VERSION

VERSION=$GAP_VERSION

AC_SUBST(GAP_MAJOR_VERSION)
AC_SUBST(GAP_MINOR_VERSION)
AC_SUBST(GAP_MICRO_VERSION)
AC_SUBST(GAP_VERSION)
	
AC_DEFINE_UNQUOTED(GAP_MAJOR_VERSION, $GAP_MAJOR_VERSION, [gimp-gap major release number])
AC_DEFINE_UNQUOTED(GAP_MINOR_VERSION, $GAP_MINOR_VERSION, [gimp-gap minor release number])
AC_DEFINE_UNQUOTED(GAP_MICRO_VERSION, $GAP_MICRO_VERSION, [gimp-gap micro release number])


GETTEXT_PACKAGE=gimp20-gap
AC_SUBST(GETTEXT_PACKAGE)
AC_DEFINE_UNQUOTED(GETTEXT_PACKAGE, "$GETTEXT_PACKAGE",
                   [The gettext translation domain.])

AM_INIT_AUTOMAKE(gimp-gap, $VERSION)

AM_MAINTAINER_MODE

AC_PROG_CC
AC_ISC_POSIX
AM_PROG_CC_STDC
AC_HEADER_STDC

AC_PROG_RANLIB

ACLOCAL="$ACLOCAL $ACLOCAL_FLAGS"

AC_CHECK_HEADERS(unistd.h)
AC_CHECK_FUNCS(bind_textdomain_codeset)


PKG_CHECK_MODULES(GIMP, gimp-2.0 >= 2.2.0 gimpui-2.0 >= 2.2.0 gimpthumb-2.0)

GIMP_DATA_DIR=`$PKG_CONFIG gimp-2.0 --variable=gimpdatadir`
GIMP_PLUGIN_DIR=`$PKG_CONFIG gimp-2.0 --variable=gimplibdir`

AC_SUBST(GIMP_DATA_DIR)
AC_SUBST(GIMP_PLUGIN_DIR)



dnl Test for unix-frontends
dnl -----------------------
AC_ARG_ENABLE(unixfrontends,
              [  --disable-unix-frontends     don't build with UNIX specific frontends for xanim and mpeg encoders])
  if test "x$enable_unix_frontends" != "xno"; then
    frontends_warning="
gimp-gap is configured with Linux/UNIX specific frontends for xanim
and mpeg encoders. Non Linux/UNIX users should run configure with
the --disable-unix-frontends option.
"
  else
    frontends_warning="
The Linux/UNIX specific frontends for xanim and mpeg encoders will
not be built. This is OK for non Linux/UNIX users.
"
  fi

AM_CONDITIONAL(GAP_UNIX_FRONTENDS, test "x$enable_unix_frontends" != "xno")



dnl Test for videoapisupport
dnl ------------------------
AC_ARG_ENABLE(videoapisupport,
              [  --disable-videoapi-support   don't build with videoapi support])
  if test "x$enable_videoapi_support" != "xno"; then
    AC_DEFINE(GAP_ENABLE_VIDEOAPI_SUPPORT, 1, [Define to 1 to enable videoapi support])
  else
        videoapi_warning="
gimp-gap is configured without video API (libgapvidapi.a)
   There will be NO access to videofiles (mpeg, avi...) in the storyboard
   plug-in and the videoextract plug-in will not work at all.
   To compile with video API run configure with
   the --enable-videoapi-support option.
"

  fi

AM_CONDITIONAL(GAP_VIDEOAPI_SUPPORT, test "x$enable_videoapi_support" != "xno")


dnl get name of current and parent dir
pwd_dir=`pwd`
cd ..
parent_dir=`pwd`
cd "$pwd_dir"

dnl Test for video libavformat (FFMPEG)
dnl -----------------------------------
dnl the ffmpeg libs are both used as decoder implementations in the GAP Video API (GVA)
dnl and in the ffmpeg videoencoder  plug-in
dnl ffmpeg should compile on many operating systems, including UNIX and WINDOWS systems
dnl
dnl the current gimp-gap preferes static linking with ffmpeg (versions 0.4.8 upto recent CVS versions)
dnl therefore the ffmpeg sourcetree should be specified --with-ffmpegdir=DIR
dnl a permanent ffmpeg installation is not required in that case, but the libraries 
dnl   libavformat.a and libavcodec.a
dnl must be already built there. 
dnl
dnl
dnl FFMPEG_DIRNAME="ffmpeg-0.4.8"
dnl FFMPEG_DIRNAME="ffmpeg-0.4.9-pre1"
dnl FFMPEG_DIRNAME="FFMpeg-20050120"
dnl FFMPEG_DIRNAME="FFMpeg-20050228"
dnl FFMPEG_DIRNAME="FFMpeg-20050302"
FFMPEG_DIRNAME="FFMpeg-20050302"

dnl check if ffmpeg sourcedir (expanded ffmpeg tarball) is specified
FFMPEG_DIR="$parent_dir/extern_libs/$FFMPEG_DIRNAME"
AC_ARG_WITH(ffmpegsrcdir, [  --with-ffmpegsrcdir=DIR      specify where to find ffmpeg src directory DIR],
if eval "test x$with_ffmpegsrcdir != x"; then
  if eval "test x$with_ffmpegsrcdir != xyes"; then
    FFMPEG_DIR=$with_ffmpegsrcdir
  fi
fi)


AC_ARG_ENABLE(libavformat,
              [  --disable-libavformat        don't build with libavformat/libavcodec])
  if test "x$enable_libavformat" != "xno"; then
    dnl

    AC_DEFINE(ENABLE_GVA_LIBAVFORMAT, 1, [Define to 1 to enable compile and link with libavformat])
    dnl
    dnl
    if test -d "$FFMPEG_DIR"; then
      dnl
      echo "FFMPEG sourcetree found at dir: $FFMPEG_DIR"
      dnl
      dnl STATIC linking of the ffmpeg libs libavformat.a libavcodec.a
      dnl from sourcedirectory
      dnl
      dnl   sequence of libs does matter  1. libavformat.a  2. libavcodec.a 
      FFMPEG_LIBAVFORMAT_A="$FFMPEG_DIR/libavformat/libavformat.a"
      FFMPEG_LIBAVCODEC_A="$FFMPEG_DIR/libavcodec/libavcodec.a"

      GAP_VLIBS_FFMPEG=" $FFMPEG_LIBAVFORMAT_A $FFMPEG_LIBAVCODEC_A "
      GAP_VINCS_FFMPEG=" -I$FFMPEG_DIR/libavcodec -I$FFMPEG_DIR/libavformat "

      vid_ffmpeg_warning=""
      if test -f "$FFMPEG_LIBAVFORMAT_A"; then
        echo "libavformat found: $FFMPEG_LIBAVFORMAT_A"
      else
        vid_ffmpeg_warning="$vid_ffmpeg_warning
** libavformat not found at:
   $FFMPEG_LIBAVFORMAT_A
"
      fi

      if test -f "$FFMPEG_LIBAVCODEC_A"; then
        echo "libavcodec found: $FFMPEG_LIBAVCODEC_A"
      else
        vid_ffmpeg_warning="$vid_ffmpeg_warning
** libavcodec not found at:
   $FFMPEG_LIBAVCODEC_A
"
      fi
      
      if test "x$vid_ffmpeg_warning" != "x"; then
        vid_ffmpeg_warning="$vid_ffmpeg_warning
        please first build the ffmpeg libraries.
        Therefore you may cd to DIR: 
          $FFMPEG_DIR
        then run 
          ./configure and make:
"
      fi      
      dnl
      dnl
    else
      if eval "test x$with_ffmpegsrcdir != x"; then
         vid_ffmpeg_warning="
** ffmpeg sourcetree was not found at:       
$FFMPEG_DIR
you can get the ffmpeg tarball at:
http://ffmpeg.sourceforge.net.
"
      else
        if test -d "/usr/local/include/ffmpeg"; then
          GAP_VINCS_FFMPEG=" -I/usr/local/include/ffmpeg"
        else
          if test -d "/usr/include/ffmpeg"; then
            GAP_VINCS_FFMPEG=" -I/usr/include/ffmpeg"
	  else
            vid_ffmpeg_warning="
** ffmpeg include directory not found at:       
/usr/local/include/ffmpeg
/usr/include/ffmpeg
you can get the ffmpeg libs at:
http://packages.debian.org/unstable/libdevel/libavcodec-dev
http://packages.debian.org/unstable/libdevel/libavformat-dev
or
alternative you can get the ffmpeg tarball at:
http://ffmpeg.sourceforge.net.
"
	  fi
	fi
      fi

      dnl options for dynamic linking
      GAP_VLIBS_FFMPEG=" -lavcodec -lavformat"
      dnl
    fi    
  else
        vid_ffmpeg_warning="
gimp-gap is configured without libavformat
   This reduces the number of supported videoformats both for read and write
   access. libavformat and libavcodec are part of $FFMPEG_DIRNAME.

Warning: checks for libavformat and libavcodec are not implemented yet.
You can get ffmpeg at: http://ffmpeg.sourceforge.net.
"
        GAP_VLIBS_FFMPEG=" "
        GAP_VINCS_FFMPEG=" "
  fi

AM_CONDITIONAL(ENABLE_GVA_LIBAVFORMAT_SUPPORT, test "x$enable_libavformat" != "xno")


dnl Test for video libmpeg3
dnl ------------------------
dnl libmpeg3 is used in one of the decoder implementations in the GAP Video API (GVA)
dnl as far as i know this lib is available only on UNIX systems
dnl
dnl the current gimp-gap includes the libmpeg3-1.5.4 as (unmaintained) sourcetree
dnl and calls the libmpeg3 configure script.
dnl The generated Makefile will call the libmpeg3 original Makefile to buld the library 
dnl   libmpeg3.a
dnl linking with gimp-gap modules is now done statically. 
dnl
REQ_LIBMPEG3_VERSION="1.5.4"


dnl check if libmpeg3 sourcedir (expanded ffmpeg tarball) is specified
LMPEG3_DIR="$parent_dir/extern_libs/libmpeg3-$REQ_LIBMPEG3_VERSION"
AC_ARG_WITH(libmpeg3srcdir, [  --with-libmpeg3srcdir=DIR    specify where to find libmpeg3 src directory DIR],
if eval "test x$with_libmpeg3srcdir != x"; then
  if eval "test x$with_libmpeg3srcdir != xyes"; then
    LMPEG3_DIR=$with_libmpeg3srcdir
  fi
fi)


AC_ARG_ENABLE(libmpeg3,
              [  --disable-libmpeg3           don't build with libmpeg3])
  if test "x$enable_libmpeg3" != "xno"; then
    dnl
    dnl the original tarball from http:www.heroinewarrior.com of libmpeg3-1.5.4
    dnl comes without installation help for the library and its headers.
    dnl but (some ?) LINUX distributors provide installation rpm packages for libmpeg3
    dnl
    dnl some older libmpeg3-1.5 rpm packages (from my SuSE 8.2 distribution) are NOT compatible
    dnl with the new API, and have limited functions -- AC3 is turned off --
    dnl other packages (like the current debian) disable CSS decrytion.
    dnl
    dnl one solution to face those problems
    dnl is to get the tarball with the full sourcetree of the libmpeg3-1.5.4 library
    dnl configure and make the libmpeg3 from sourcetree
    dnl and then link statically by specifying the option --with-libmpeg3srcdir.
    dnl
    dnl libmpeg3 needs the assembler nasm to compile
    dnl and checks this requirement in its configuration script.
    dnl
    machine_dependent_odir=`uname --machine`
    dnl
    if test -d "$LMPEG3_DIR"; then
      dnl
      echo "LIBMPEG3 sourcetree found at dir: $LMPEG3_DIR"
      dnl
      LMPEG3_A="$LMPEG3_DIR/$machine_dependent_odir/libmpeg3.a"
      dnl
      if test -f "$LMPEG3_A"; then
        echo "libmpeg3 found: $LMPEG3_A"
	GAP_VLIBS_MPEG3=" $LMPEG3_A "
	GAP_VINCS_MPEG3=" -I$LMPEG3_DIR -I$LMPEG3_DIR/audio -I$LMPEG3_DIR/video "
	AC_DEFINE(ENABLE_GVA_LIBMPEG3, 1,
           [Define to 1 to enable compile and link with libmpeg3])
      else
        vid_mpeg3_warning="
** libmpeg3 not found at:
   $LMPEG3_A
please first build the library. Therefore you may run ./configure and make at DIR:
   $LMPEG3_DIR
"
      fi

      dnl
    else
      GAP_VLIBS_MPEG3=" "
      GAP_VINCS_MPEG3=" "
      if eval "test x$with_libmpeg3srcdir != x"; then
        vid_mpeg3_warning="
** libmpeg3 sourcetree was not found. at:
   $LMPEG3_DIR
You can get the required tarball libmpeg3-$REQ_LIBMPEG3_VERSION at:
http://www.heroinewarrior.com/download.php3
"
      else
        dnl check for typic libmpeg3 installation (debian)
        dnl the debian release of libmpeg3 was built with disabled CSS option
        dnl and does not permit reading of CSS encrypted DVD .vob files.
        if test -f "/usr/local/include/libmpeg3.h"; then
          LMPEG3_IDIR="/usr/local/include"
          LMPEG3_A="/usr/local/lib/libmpeg3.a"
          GAP_VLIBS_MPEG3=" $LMPEG3_A "
          GAP_VINCS_MPEG3=" -I$LMPEG3_IDIR -I$LMPEG3_IDIR/audio -I$LMPEG3_IDIR/video "
        elif test -f "/usr/include/libmpeg3.h"; then
          LMPEG3_IDIR="/usr/include"
          LMPEG3_A="/usr/lib/libmpeg3.a"
          GAP_VLIBS_MPEG3=" $LMPEG3_A "
          GAP_VINCS_MPEG3=" -I$LMPEG3_IDIR -I$LMPEG3_IDIR/audio -I$LMPEG3_IDIR/video "
        else
          vid_mpeg3_warning="
** libmpeg3 header files were not found. at:
  /usr/local/include
  /usr/include
You can get libmpeg3 at
http://packages.debian.org/unstable/libdevel/libmpeg3-dev
alternative you can get the source tarball libmpeg3-$REQ_LIBMPEG3_VERSION at:
http://www.heroinewarrior.com/download.php3
"
	fi
      fi
    fi  
  else
    if test "x$enable_videoapi_support" != "xno"; then
        vid_mpeg3_warning="
gimp-gap is configured without libmpeg3
   This reduces the number of supported videoformats for read access.
   You can get libmpeg3-$REQ_LIBMPEG3_VERSION at: 
   http://www.heroinewarrior.com/download.php3
"
      GAP_VLIBS_MPEG3=" "
      GAP_VINCS_MPEG3=" "
    fi
  fi

AM_CONDITIONAL(ENABLE_GVA_LIBMPEG3_SUPPORT, test "x$enable_libmpeg3" != "xno")



dnl Test for XVID codec
dnl ------------------------
dnl the xvid codec lib is used in the AVI videoencoder plug-in for MPEG4 support
dnl xvid should compile on many operating systems, including UNIX and WINDOWS systems
dnl (ffmpeg has its own builtin MPEG4 codec implementation and does not depend on this codec)
dnl
AC_ARG_ENABLE(libxvidcore,
              [  --disable-libxvidcore        don't build with libxvidcore])
  if test "x$enable_libxvidcore" != "xno"; then
    dnl
    dnl hof: TODO: here we should check for libxvidcore 1.0.0
    dnl the temporary workaround uses the hardcoded default /usr/local/include
    dnl
    AC_DEFINE(ENABLE_LIBXVIDCORE, 1, [Define to 1 to enable compile and link with libavformat])
    GAP_VLIBS_XVIDCORE=" -lxvidcore"
    GAP_VINCS_XVIDCORE=" -I/usr/local/include"
  else
        vid_xvidcore_warning="
gimp-gap is configured without libxvidcore
   The AVI encoder plug-in is built without MPEG4 support.
   You can get the xvid codec at:  http://www.xvid.org/downloads.html
"
        GAP_VLIBS_XVIDCORE=" "
        GAP_VINCS_XVIDCORE=" "

  fi

AM_CONDITIONAL(ENABLE_LIBXVIDCORE_SUPPORT, test "x$enable_libxvidcore" != "xno")



dnl Test for video libquicktime (QUICKTIME4LINUX)
dnl ---------------------------
dnl WARNING: libquicktime is in experimental state and probably will be removed later
dnl 
dnl AC_ARG_ENABLE(libquicktime,
dnl               [  --enable-libquicktime       don't build with libquicktime])
dnl   if test "x$enable_libquicktime" = "xyes"; then
dnl    dnl
dnl    dnl Linking with quicktime not finished yet
dnl    dnl      the current video API once worked with old quicktime libs
dnl    dnl      the new quicktime4linux comes with ffmpeg as subset but did not
dnl    dnl      even compile on my machine. therefore this version of gimp-gap has NO QUICKTIME support
dnl    dnl AC_DEFINE(ENABLE_GVA_LIBQUICKTIME, 1, [Define to 1 to enable compile and link with libquicktime])
dnl    GAP_VLIBS_QUICKTIME=" "
dnl    GAP_VINCS_QUICKTIME=" "
dnl     vid_quicktime_warning="
dnl gimp-gap libquicktime support is NOT fully implemented 
dnl and currently does not even compile (forced option --disable-libquicktime)
dnl "
dnl   else
    GAP_VLIBS_QUICKTIME=" "
    GAP_VINCS_QUICKTIME=" "
dnl
dnl  fi

AM_CONDITIONAL(ENABLE_GVA_LIBQUICKTIME_SUPPORT, test "x$enable_libquicktime" != "xno")


AC_SUBST(GAP_VLIBS_FFMPEG)
AC_SUBST(GAP_VINCS_FFMPEG)
AC_SUBST(GAP_VLIBS_MPEG3)
AC_SUBST(GAP_VINCS_MPEG3)
AC_SUBST(GAP_VLIBS_QUICKTIME)
AC_SUBST(GAP_VINCS_QUICKTIME)
AC_SUBST(GAP_VLIBS_XVIDCORE)
AC_SUBST(GAP_VINCS_XVIDCORE)

AC_SUBST(FFMPEG_DIR)
AC_SUBST(FFMPEG_LIBAVFORMAT_A)
AC_SUBST(FFMPEG_LIBAVCODEC_A)
AC_SUBST(LMPEG3_DIR)
AC_SUBST(LMPEG3_A)

GAPVIDEOAPI_EXTLIBS="$GAP_VLIBS_FFMPEG $GAP_VLIBS_MPEG3 $GAP_VLIBS_QUICKTIME -lpng -lz -lpthread -ldl -lm"
GAPVIDEOAPI_EXTINCS="$GAP_VINCS_FFMPEG $GAP_VINCS_MPEG3 $GAP_VINCS_QUICKTIME"
AC_SUBST(GAPVIDEOAPI_EXTLIBS)
AC_SUBST(GAPVIDEOAPI_EXTINCS)




dnl Test for audiosupport
dnl ------------------------
AC_ARG_ENABLE(audiosupport,
              [  --disable-audio-support      don't build with audio support])
  if test "x$enable_audio_support" != "xno"; then
    AC_CHECK_PROG(WAVPLAY_SERVER, wavplay, yes, no)
      if test $WAVPLAY_SERVER = no; then
        audio_warning="
Audio support will be compiled in but will not work because the wavplay
executable was not found. For audio support the wavplay audioserver must
be installed at runtime.
"
      fi

    AC_DEFINE(GAP_ENABLE_AUDIO_SUPPORT, 1, [Define to 1 to enable audio support])
  fi

AM_CONDITIONAL(GAP_AUDIO_SUPPORT, test "x$enable_audio_support" != "xno")

dnl optional compile preview widget with GDK-pixbuf support
dnl 
AC_ARG_ENABLE(gdkpixbuf,
              [  --enable-gdkpixbuf-pview     use GdkPixbuf thumbnail rendering (default=no)])
  if test "x$enable_gdkpixbuf_pview" = "xyes"; then
    AC_DEFINE(GAP_PVIEW_USE_GDK_PIXBUF_RENDERING, 1, [use Gdk for Pixbuf rendering in gap preview widget])
  fi





GAPLIBDIR=${libdir}/$PACKAGE-$GAP_MAJOR_VERSION.$GAP_MINOR_VERSION


ALL_LINGUAS="az ca cs da de el en_GB es eu fi fr gu hi hr hu it ja ko lt ml ne nl nn no pa pl pt pt_BR ru rw sk sl sq sr sr@Latn sv tr uk zh_CN zh_TW"

AC_PROG_INTLTOOL
AM_GLIB_GNU_GETTEXT

LOCALEDIR='${datadir}/locale'


dnl Use -Wall if we have gcc.
changequote(,)dnl
if test "x$GCC" = "xyes"; then
  case " $CFLAGS " in
  *[\ \	]-Wall[\ \	]*) ;;
  *) CFLAGS="$CFLAGS -Wall" ;;
  esac
fi
changequote([,])dnl

CPPFLAGS="$CPPFLAGS -DG_DISABLE_DEPRECATED -DGDK_DISABLE_DEPRECATED -DGIMP_DISABLE_DEPRECATED"

AC_SUBST(GAPLIBDIR)
AC_SUBST(LOCALEDIR)

AC_OUTPUT([
Makefile
images/Makefile
gap/Makefile
libwavplayclient/Makefile
libgapvidapi/Makefile
libgapvidutil/Makefile
vid_common/Makefile
vid_enc_avi/Makefile
vid_enc_ffmpeg/Makefile
vid_enc_single/Makefile
po/Makefile.in
docs/Makefile
docs/howto/Makefile
docs/howto/txt/Makefile
docs/reference/Makefile
docs/reference/txt/Makefile
])

AC_MSG_RESULT($frontends_warning $audio_warning $videoapi_warning $vid_ffmpeg_warning $vid_mpeg3_warning $vid_quicktime_warning)
