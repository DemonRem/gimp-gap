STORYBOARD_FILES           2004.04.24:


WARNING:
--------
This STORYBOARD_FILE specification is still under development.
Expect there will be changes until the first stable release.

// TODO: this docfile is not up to date with the currrent development state:
//
// - mark features that are only available in level2 STORYBOARD syntax
// - Named Parameters: Param Names have changed 
//   - nloops replaces repeat
//   - nframes replaces duration
//   - duration style (int == frames, float == secs) may change (in future)
//     by using different parmeter names (nframes or seconds
// - Named Parameters: new style is key:value
//     (old style  value=key is deprecated but still supported) 


General
-------
A STORYBOARD_FILE is a textfile that can be used to
assemble many audiofiles, videoclips, single images and frame sequences 
to one resulting video.

The images and frame sequences may be located in different directories,
and can contain frame_images of any imagefiletype
(.jpg, .xcf, .gif ...) that is readable by GIMP.
You may also use parts from videofiles.
(.mpg ... see chapter supported video input)

all frames are converted and scaled to the desired
video master size on the fly at encoding time.

All frame sequences and videoclips are played at the desired
master framerate. This will result in speed up or
slow down in all non rate-matching sequences.

The built in audio processing has support for
uncompressed audio in the RIFF WAVE format,
but you can use any other Auidoformat if you
have installed an external converter tool.

sox and lame are configured as default
converter tools, so it is possible
to use many differnt audio formats
(including mp3). Recoding and resampling
is done automatically where needed.





Syntax:
-------
The STORYBOARD_FILE is organized in textlines with blank
seprated items. The 1.st item is a Keyword that describes
the RECORD Type of the line.
The other items depend on the RECORD Type.
Lines starting with # are Comments, Blanklines are allowed and will be ignored.

You may join 2 or more Lines to one logical Line
if you set the backslash '\' as last charcter 
(immediate before newline)


item values may be specified using a parametername prefix
in the style:

   key:valu

item values may have a comment suffix starting with =

items that specify a duration or a timestamp can have
unit FRAMES or SECONDS dependig on the way how the
value is written.
Here are some Examples:

     7    ..... 7 FRAMES
   007    ..... 7 FRAMES
     7.0  ..... 7 Seconds (same as 168 frames for a framerate of 24 fps (7 * framerate))

  File Example:

   VID_MASTER_FRAMERATE  24.0=frames_per_sec
   VID_PLAY_FRAMES        1=track   animframes_  .xcf   2  1.5

   Play the framerange from frame number 2:    animframes_0002.xcf
   until frame number 36 (1.5 sec * 24.0 fps)  animframes_0036.xcf



Overview of supported RECORD TYPES:
----------------------------------

STORYBOARDFILE    1.0=version  # comments


VID_MASTER_FRAMERATE  24.0=frames_per_sec
VID_MASTER_SIZE       320=width  200=height
VID_MASTER_CHANNEL     1=channel  1;2;3;4=track_members
VID_PREFERRED_DECODER  libavformat

AUD_MASTER_VOLUME      1.0=volume
AUD_MASTER_SAMPLERATE 44100=samples_per_sec
AUD_MASTER_CHANNEL     2=channel  5;6;7;8=track_members

# video frames
VID_PLAY_MOVIE     1=track  movie_filename     0001=frame_from 0099=frame_to  {pingpong|normal} 1=repeatcount \
                                     1=selecttrack \
                                     0=exact_seek \
                                     1.0=deinterlace \
                                     macro_filename
VID_PLAY_ANIMIMAGE 1=track  image_filename     0001=layer_from 0099=layer_to  {pingpong|normal} 1=repeatcount macro_filename
VID_PLAY_FRAMES    1=track  basename extension 0001=frame_from 0099=frame_to  {pingpong|normal} 1=repeatcount macro_filename
VID_PLAY_IMAGE     1=track  image_filename                         0001=duration_frames macro_filename
VID_PLAY_COLOR     1=track  0.0=red 1.0=green 0.0=blue 1.0=alpha   0001=duration_frames
VID_SILENCE        1=track                                         0001=duration_frames  0.0=wait_until_sec
# video attributes
VID_OPACITY        1=track  0.0=opacity_from     1.0=opacity_to    10=duration_frames
VID_ZOOM_X         1=track  0.1=zoom_x_from     10.0=zoom_x_to     10=duration_frames
VID_ZOOM_Y         1=track  0.1=zoom_y_from     10.0=zoom_y_to     10=duration_frames
VID_MOVE_X         1=track -1.0=move_x_from      1.0=move_x_to     10=duration_frames
VID_MOVE_Y         1=track -1.0=move_y_from      1.0=move_y_to     10=duration_frames
VID_FIT_SIZE       1=track  {both|none|width|height}  {keep_proportions|change_proportions}


# audio
AUD_PLAY_SOUND     1=track  audiofile 0.0=start_sec 10.2=end_sec \
                             1.0=volume 
                             0.0=start_vol 1.0=fade_in_time
                             0.0=end_vol   1.0=fade_out_time
                             1=repeatcount
AUD_PLAY_MOVIE     1=track  audiofile 0.0=start_sec 10.2=end_sec \
                             1.0=volume 
                             0.0=start_vol 1.0=fade_in_time
                             0.0=end_vol   1.0=fade_out_time
                             1=repeatcount
                             1=selecttrack
AUD_SILENCE        1=track  0.0=duration_sec  10.2=wait_until_sec
AUD_TRACK          1=track  {on | off}




RECORD Types Details:
---------------------

Here is the detailed description of the items for the
supported RECORD Types. optional items have internal defaults
and can be omitted.

  required item numbers (1)
  optional item numbers [7]
  

STORYBOARDFILE
  File Header. This Record mut be the 1.st Line in the file.

  (1) Record Key        ... STORYBOARDFILE
  (2) version           ... version string (1.0 for the current implementation)

VID_PREFERRED_DECODER
  (1) Record Key        ... VID_PREFERRED_DECODER
  (2) decoder_name      ... Name of the preferred Videodecoder
                            The Videodecoder is relevant for all Clips
			    specified with VID_PLAY_MOVIE or AUD_PLAY_MOVIE statements.
			    If you set a preferred Videodecoder this one tried first.
			    If it fails to open the videofile, all other decoders
			    are tried next.
                            Currently you may choose the following decoders:
			      libavformat
			      libmpeg3
			      quicktime4linux
                            DEFAULT: NULL (no preferred decoder)

VID_PLAY_MOVIE
  fetch frames from a videofile. (such as MPEG, AVI, ...
  see GAP_VID_API description for Informations about 
  supported videoformats and codecs)


  (1) Record Key        ... VID_PLAY_MOVIE
  (2) track             ... integer tracknumer
  (3) video_filename    ... filename of the video.
  (4) frame_from        ... start of Range Framenumber (integer)  or seconds (float)
                            (where 1 is the first frame in the video)
  (5) frame_to          ... end of Range Framenumber (integer) or seconds (float)
                            (see Range description for more information)
  [6] mode              ... optional keyword "pingpong" or "normal"
                            DEFAULT: "normal"
  [7] repeatcount       ... optional integer of Range repetitions
                            DEFAULT: 1
  [8] videotrack        ... Select input videotrack (for videos with more viedeotracks.
                            use 1 for the first track, or if the video has only one videotrack)
                            DEFAULT: 1
  [9] exact_seek        ... 0 .. use faster seek ops for Videoframe reads (positioning may not be exact)
                            1 .. force sequential reads for exact positioning (in the Video Read API (GVA))
                            that will be execute on each imported input_layer
                            DEFAULT: 1
 [10] deinterlace       ... 0.0 (upto 0.99)  read videoframes 1:1 without deinterlacing
                            1.0 upto 1.99  deinterlace videoframes keeping odd rows
                                where 1.0 does not interpolate the even rows (hard) 
                                and   1.99 does soft interpolation for the even rows.
                            2.0 upto 2.99    deinterlace videoframes keeping even rows
                            DEFAULT: 0.0
 [11] macro_filename    ... optional name of a filtermacro_file
                            that will be execute on each imported input_layer


VID_PLAY_ANIMIMAGE
  fetch frames from layers of a multilayer image (such as GIF animations,
  or animations in GIMP native XCF fileformat)

  (1) Record Key        ... VID_PLAY_ANIMIMAGE
  (2) track             ... integer tracknumer
  (3) image_filename    ... filename of the multilayer image.
  (4) layer_from        ... start of Range layernumber (integer)  or seconds (float)
                            (where 0 is the top layer in the multilayer image)
  (5) layer_to          ... end of Range layernumber (integer) or seconds (float)
                            (see Range description for more information)
  [6] mode              ... optional keyword "pingpong" or "normal"
                            DEFAULT: "normal"
  [7] repeatcount       ... optional integer of Range repetitions
                            DEFAULT: 1
  [8] macro_filename    ... optional name of a filtermacro_file
                            that will be execute on each imported input_layer

VID_PLAY_FRAMES
  fetch frames from numbered imagefiles with names follow the convention
     - base_filename (may include directory path)
     - number
     - .
     - extension
  such as supported by GIMP Video Menu functions.

  
  (1) Record Key        ... VID_PLAY_FRAMES
  (2) track             ... integer tracknumer
  (3) base_filename     ... filename prefix part before the framenumber.
  (4) extension         ... Extension (without '.'  jpg, gif xcf ...)
  (5) from              ... start of Range frame number (integer) or seconds (float) or keyword
  (6) to                ... end of Range frame number (integer) or seconds (float) or keyword
                            (see Range description for more information)
  [7] mode              ... optional keyword "pingpong" or "normal"
                            DEFAULT: "normal"
  [8] repeatcount       ... optional integer of Range repetitions
                            DEFAULT: 1
  [9] macro_filename    ... optional name of a filtermacro_file
                            that will be execute on each imported input frame

VID_PLAY_IMAGE
  fetch frame from a single imagefile. (Multilayer Images are handled as
  one composite image. For animated GIF's you can use VID_PLAY_ANIMIMAGE
  to playback all the layers seperately)
  
  (1) Record Key        ... VID_PLAY_IMAGE
  (2) track             ... integer tracknumer
  (3) image_filename    ... filename of the image.
  [4] duration          ... optional duration in number of frames (integer) or seconds (float)
                            DEFAULT: 1
  [5] macro_filename    ... optional name of a filtermacro_file
                            that will be execute on the imported input image


VID_PLAY_COLOR
  create unicolored frame.
  
  (1) Record Key        ... VID_PLAY_COLOR
  (2) track             ... integer tracknumer
  (3) red               ... 0.0 upto 1.0 
  (4) green             ... 0.0 upto 1.0 
  (5) blue              ... 0.0 upto 1.0 
  (6) alpha             ... 0.0 upto 1.0  alphachannel 
                            (where 0.0 is full transparent and 1.0 is full opaque) 
  [7] duration          ... duration in number of frames (integer) or seconds (float)
                            DEFAULT: 1

VID_SILENCE
  This record is used to define Pauses in a videotrack. 
  
  (1) Record Key        ... VID_SILENCE
  (2) track             ... integer tracknumer
  [3] duration          ... duration of the silent pause in number of frames (integer) 
                            or seconds (float)
                            DEFAULT: 1
  [4] wait_until        ... wait until this timestamp is reached,
                            (then wait duration time)
                            timestamp can be a framenumber (integer) or seconds (float)
                            DEFAULT: 0

VID_OPACITY
  This record is used to define Fade Effects,
  by changing the Opacity of the Videotrack slightly from one value
  to another.
  
  (1) Record Key        ... VID_OPACITY
  (2) track             ... integer tracknumer
  (3) opacity_from      ... Start opacity with this value
                            where 0.0 is full transparent and 1.0 is full opaque
  [4] opacity_to        ... Change opacity to this value
                            DEFAULT: use same value as opacity_from
  [5] duration          ... optional duration of the effect
                            in number of frames (integer) or seconds (float) 
                            The duration Value 0 applies the TO value immediate.
                            DEFAULT: 0

VID_ZOOM_X and VID_ZOOM_Y
  These records are used to define Zooming Effects
  by changing the Opacity of the Videotrack slightly from one value
  to another. Zooming can be defined independet for Width (VID_ZOOM_X)
  and Height (VID_ZOOM_Y).
  
  (1) Record Key        ... VID_ZOOM_X  (or VID_ZOOM_Y)
  (2) track             ... integer tracknumer
  (3) zoom_from         ... Start zoom with this value
                            where 0.0 is 1x1 Pixel, 1.0 is fit videosize, 2.0 is double videosize
  [4] zoom_to           ... Change opacity to this value
                            DEFAULT: use same value as opacity_from
  [5] duration          ... optional duration of the effect 
                            in number of frames (integer 10) or seconds (float) 
                            The duration Value 0 applies the TO value immediate.
                            DEFAULT: 0


VID_MOVE_X and VID_MOVE_Y
  These records are used to define Scroll Effects
  by changing the Offset(s) of the Videotrack slightly from one value
  to another. Scrolling can be defined independet for X (VID_MOVE_X)
  and Y Directions (VID_MOVE_Y).
  
  (1) Record Key        ... VID_MOVE_X  (or VID_MOVE_Y)
  (2) track             ... integer tracknumer
  (3) move_from         ... Start move with this value
                            where -1.0 is left (or up) outside,
                                   0.0 is centered,
                                  +1.0 is right (or bottom) outside
  [4] move_to           ... Change offset to this value
                            DEFAULT: use same value as move_from
  [5] duration          ... optional duration time of the effect 
                            in number of frames (integer 10) or seconds (float) 
                            The duration Value 0 applies the TO value immediate.
                            DEFAULT: 0

  Example:

    move_x_from = -1.0  
                                         
    +-----------------------------------+-----------+
    |.....tmp_width=800.................|master     |
    |.................+.................|width: 320 |
    |...................................|           |
    +-----------------------------------+-----------+
                      ^                 ^     ^ 
                      |   400           | 160 |



     delta_x_offset_from_center = ((master_width /2) + (tmp_width / 2)) * move_x_from
     -560 = (400 + 160) * -1.0


    move_x_to = 0.5  
       
                                     +--+===========+--------------------+
                                     |..|master.....|....................|
                                     |..|width:.320.|..+.................|
                                     |..|...........|....................|
                                     +--+===========+--------------------+
                                              ^        ^ 
                                              |   280  |


     delta_x_offset_from_center = ((master_width /2) + (tmp_width / 2)) * move_x_from
     280 = (400 + 160) * 0.5


VID_FIT_SIZE
  Define how to match input framesize with the size of
  the resulting video (VID_MASTER_SIZE).

  Notes:
  - The Input Frame is placed in the center of the 
    composite output frame.
    (unless VID_MOVE_X/Y define other offsets than 0.0)
  - Zooming may cause additional Scaling. The VID_FIT_SIZE
    describes the normal Size (where zoom is set to 1.0)


  The described behavior is valid for all fetched Frames in the same track
  until the next VID_FIT_SIZE record (or until end of file if there is none)
  
  (1) Record Key        ... VID_FIT_SIZE
  (2) track             ... integer tracknumer
  [3] mode              ... One of the Keywords "width" "height" "none" or "both"
                            width:  Scale that only width does exactly
                                    fit to the resulting video, height is unchanged
                            height: Scale that only height does exactly
                                    fit to the resulting video, width  is unchanged
                            both:   Scale that both width and height do exactly
                                    fit to the resulting video 
                            none:   Do not Scale the input frame at all
                            DEFAULT "both"
                            
  [4] proportions           ... One of the Keywords "keep_proportions" "change_proportions"
                            keep_proportions:
                                    Keep proportions of the input frame at scaling.
                                    This can lead to black stripes on top/bottom
                                    (or left/right).
                                    especially if the resulting video is LANDSCAPE oriented
                                    and the input frame is PORTRAIT oriented.
                            change_proportions:
                                    allow proportion changes at scaling.
                                    Stretch the image to fit the resulting
                                    video.
                                    
                            DEFAULT: "change_proportions"


AUD_PLAY_SOUND
  This record is used for playback of portions of an audiofile,
  with optional fade effects. Please note that all audiotracks
  are mixed to one composite audiotrack.

  (1) Record Key        ... AUD_PLAY_SOUND
  (2) track             ... integer tracknumer
  (3) audio_filename    ... filename of soundfile (.WAV and other types).
  (4) start             ... start playback range at offest in seconds (float)
                            or in frames (int)
  (5) end               ... end playback range at offest in seconds (float)
                            or in frames (int)
  [6] volume            ... adjust the volume. (float)
                            A value of 1.0 keeps the original input volume for this track
                            value 0.5 results in half, value 2.0 in double volume.
                            (the result may be additional affected by the MASTER_VOLUME,
                            that is applied to the mixed composite audio)
                            DEFAULT = 1.0
  [7] start_volume      ... Start Value of the volume. (float)
                            DEFAULT: 1.0
  [8] fade_in_duration  ... duration for the fade in. In this durationtime the input volume
                            changes slightly from start_volume --> to volume.
                            Duration can be specified in Seconds (float) or frames (int).
                            With value 0 the playback starts immediate with volume,
                            there will be no fade-in at all.
                            DEFAULT: 0
  [9] end_volume        ... End Value of the volume.. (float)
                            DEFAULT: 1.0
  [10]fade_out_duration ... duration for the fade out. In this durationtime the input volume
                            changes slightly from volume --> to end_volume.
                            Duration can be specified in Seconds (float) or frames (int).
                            With value 0 there will be no fade-out at all.
                            DEFAULT: 0
                            

AUD_PLAY_MOVIE
  This record is used for playback of portions of an audiotrack in an input videofile,
  with optional fade effects. Please note that all audiotracks
  are mixed to one composite audiotrack.

  (1) Record Key        ... AUD_PLAY_MOVIE
  (2) track             ... integer tracknumer
  (3) video_filename    ... filename of a video (must contain the audiotrack).
  (4) start             ... start playback range at offest in seconds (float)
                            or in frames (int)
  (5) end               ... end playback range at offest in seconds (float)
                            or in frames (int)
  [6] volume            ... adjust the volume. (float)
                            A value of 1.0 keeps the original input volume for this track
                            value 0.5 results in half, value 2.0 in double volume.
                            (the result may be additional affected by the MASTER_VOLUME,
                            that is applied to the mixed composite audio)
                            DEFAULT = 1.0
  [7] start_volume      ... Start Value of the volume. (float)
                            DEFAULT: 1.0
  [8] fade_in_duration  ... duration for the fade in. In this durationtime the input volume
                            changes slightly from start_volume --> to volume.
                            Duration can be specified in Seconds (float) or frames (int).
                            With value 0 the playback starts immediate with volume,
                            there will be no fade-in at all.
                            DEFAULT: 0
  [9] end_volume        ... End Value of the volume.. (float)
                            DEFAULT: 1.0
  [10]fade_out_duration ... duration for the fade out. In this durationtime the input volume
                            changes slightly from volume --> to end_volume.
                            Duration can be specified in Seconds (float) or frames (int).
                            With value 0 there will be no fade-out at all.
                            DEFAULT: 0
  [11] audiotrack       ... Select input audiotrack (for videos with more audiotracks
                            such as multilingual DVDs.
                            use 1 for the first audiotrack, or if the video has only
                            one audiotrack)
                            DEFAULT: 1
                            

AUD_SILENCE
  This record is used to define Pauses in an audiotrack. 
  
  (1) Record Key        ... AUD_SILENCE
  (2) track             ... integer tracknumer
  [3] duration          ... duration of the silent pause in number of frames (integer) 
                            or seconds (float)
                            DEFAULT: 1
  [4] wait_until        ... wait silently until this timestamp is reached,
                            (then do the unconditional pause for duration time)
                            timestamp can be a framenumber (integer) or seconds (float)
                            DEFAULT: 0

  Examples:
  
  a) play the the sound "hello.wav", 
     then wait silent until the total playtime has reached 60 secs.
     then start the sound "ringing.wav".
     if "hello.wav" is longer than 60 secs there will be no pause,
     (and a warning is reported)
  
  
  AUD_PLAY_SOUND 1=track  hello.wav
  AUD_SILENCE    1=track  0.0=delay  60.0=wait_until_sec
  AUD_PLAY_SOUND 1=track  ringing.wav
  
  b) play the sound "hello.wav", 
     then wait 4 seconds and start the sound "ringing.wav" exactly at sec. 60.0
  
  
  AUD_PLAY_SOUND 1=track  hello.wav
  AUD_SILENCE    1=track  4.0=delay_sec  0.0=wait_until_sec
  AUD_PLAY_SOUND 1=track  ringing.wav


Filenames:
----------
  Filenames can be prefixed by absolute pathnames,
  or by relative pathnames. Relative pathnames are relative
  to the loacation of the storyboard_file.

  Both / and \ are traeted as directory Seperator.


Videotracks:
------------
  The Videotracks in a Storyboard_file are Input tracks
  and will be merged internal to one (or more) composite Videotrack.

  (Please note that most of the Encoders
   do not support encoding of Videos with more output tracks,
   such as multiangle and or multilingual DVD stuff.
   The storyboard Syntax can describe multiple output
   tracks both for video and audio as groups of input tracks,
   but the encoders will just use video channel 0
   and audio channel 0 in most cases.
  )

  The composite Frame Image for the output Videotrack is built
  as Layerstack, where each videotrack represents one Layer
  (except for tracks where the current frame is VID_SILENCE,
  or if the track is not part of the requested output track.
  in that case no layer will be created in the composite Frame)

  The Video Track with the smallest tracknumber (0)
  is always placed on top of the Layerstack.
  Set VID_OPACITY to value 0.0 (or less than 1.0) to let
  other tracks shine through.

  If the Input Frame of a Video Track has an alpha channel,
  the layers below are visible at the transparent Regions
  of its alpha channel, even if VID_OPACITY is set to 1.0 (full opaque)
  If there is no layer below, black pixels are shown
  at full transparent regions.


Framerange:
-----------
  A Framerange is the selected portion of Frames (or Layers).
  It is specified by two numbers, FROM and TO
  and the optional keywords {"pingpong" or "normal"}
  where both numbers are included in the Framerange.
  (example: from:3 to:6  results in playback 3,4,5,6)
  
  FROM and TO can be specified as integer numbers (10  ==> unit is frames or layers)
  as float numbers (10.0 ==> unit is seconds)
  or by symolic keywords:
    "first"  for the lowest available frame number
    "last"   for the highst available frame number
    "top"    for the layer on top of the layerstack (if the Framerange refers to ANIMIMAGE)
    "bottom" for the layer on bottom of the layerstack

  If the FROM value is greater than the TO
  value, the Framerange is processed backwards.

  The "pingpong" mode extends the Framerange in the way that the frames
  are played in both directions.
  (example: from:1 to:4 pingpong results in playback 1,2,3,4,3,2)

  The repeatcount repeats the Framerange N times.
  (from:1 to:4 pingpong repeatcount:2 results in playback 1,2,3,4,3,2,  1,2,3,4,3,2)


Audiorange:
-----------
  A Audiorange is the selected portion of a soundfile (or audiotrack
  of a movie) that is to play.

  It can be specified by
    - symbolic keywords: "start" "end"
    - two float numbers (1.0 = 1 second)
    - two times in the format MM:SS:sss
      MM  .. minutes (00 upto 999999)
      SS  .. seconds (00 upto 59)
      sss .. 1/1000

  


Macrofiles:
------------
  Macros can be used to perform a user defineable set of
  one or more gimp procedures, such as 
    - deinterlace
    - color correction
    - sharpen
    - blur
    -  ...... or whatever ..
  on the handled frames of an input framerange in a video track.
  The macro is performed before
  the frame is added to the composite frame.
  
  (if you want to perform a macro on all flattened composite
  frames, you can do this directly in the common video encoder
  dialog)
  
  Macrofiles can be from type 
   - filtermacro_files

       filtermacro files are a user defineable set of filtercalls.
       You can Record any Filter Plug-In that works on a single
       drawable and is able to run with LAST VALUES in a
       filtermacro_file.
       (use the Menu  Filter->Filtermacro)
  
 
  NOTES:
   - gimp-gap filtermacro files are machine dependent,
     filtermacro support may be dropped in the future.


Supported video input
---------------------
  - MPEG1, MPEG2 (DVD) Video 
       (see docs of libmpeg3 decoder for detailed list)
  - MPEG1, MPEG2 (DVD), MPEG4 Video, AVI, WMV,
       (see docs of ffmpeg decoder for detailed list of
        supported fileformats and codecs)
  - Quicktime Video
       (quicktime4linux decoder
        only the internal CODECS: JPEG, MJPA, PNG, DV )


LIMITS:
-------
 - Video Tracknumbers are limited to integer numbers within 
   the range from 0 to 19.
 - Both / and \ are treated as directory Seperator in filenames.
  
